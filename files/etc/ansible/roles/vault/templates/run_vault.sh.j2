#!/bin/bash

PUBLIC_IP=$(curl http://169.254.169.254/latest/meta-data/public-ipv4/)
CREDENTIALS=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/sanctuary)
ACCESS_KEY=$(echo $CREDENTIALS | python -c "import json, sys; print json.load(sys.stdin)['AccessKeyId']")
SECRET_KEY=$(echo $CREDENTIALS | python -c "import json, sys; print json.load(sys.stdin)['SecretAccessKey']")
AWS_TOKEN=$(echo $CREDENTIALS | python -c "import json, sys; print json.load(sys.stdin)['Token']")

cat <<EOF > /etc/vault/vault.conf
backend "dynamodb" {
  region = "{{ vpc_region }}"
  table = "{{ vpc_table_name }}"
  access_key = "$ACCESS_KEY"
  secret_key = "$SECRET_KEY"
  session_token = "$AWS_TOKEN"
  advertise_addr = "http://$PUBLIC_IP"
}

listener "tcp" {
  address = "0.0.0.0:8200"
  tls_cert_file = "/etc/certs/server.crt"
  tls_key_file = "/etc/certs/server.key"
}
EOF

sudo vault server -config /etc/vault/vault.conf
