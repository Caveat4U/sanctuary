---
- ec2_remote_facts:
    filters:
      instance-state-name: running
      "tag:Name": "{{ vpc_sanctuary_instance_name }}"
    region: "{{ vpc_region }}"
  register: vaults

- name: Initialize vault
  shell: "vault init --address={{ vpc_procotol }}://{{ vaults.instances[0].public_dns_name }}:8200 --key-shares={{ vault_shares }} --key-threshold={{ vault_threshold }} --tls-skip-verify"
  register: init
  ignore_errors: yes

- name: Write result
  local_action: copy content={{ init.stderr }} dest=/app/init.txt
  when: init|failed

- name: Write result
  local_action: copy content={{ init.stdout }} dest=/app/init.txt
  when: not init|failed
